<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="description" content="A Multiplayer Snake/Ride game">
    <title>Snake/Ride</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.6.0/pure-min.css">
    <link rel="stylesheet" href="css/snake.css">
    <script src="/socket.io/socket.io.js"></script>
    <!--script src="https://cdn.me.io/me.io-1.3.5.js"></script-->
    <script src="https://code.jquery.com/jquery-1.11.2.min.js"></script>
    <script src="js/jquery.leanModal.min.js"></script>
  </head>
  <body>
    <div id="layout" class="content pure-g">
      <div id="nav" class="pure-u">
        <a href="#signup" id="nameBox" class="nav-menu-button">Change name</a>
        <button class="primary-button pure-button">Start</button>
          <div class="pure-menu">
            <ul id="snakes" class="pure-menu-list">
              <!--li id="snakeUniqueId">
                <a href="#" class="pure-menu-link me init">Snake 1 <span class="direction">- left</span></a>
              </li>
              <li id="snakeUniqueId">
                <a href="#" class="pure-menu-link ready">Snake 2 <span class="direction">- left</span></a>
              </li>
              <li id="snakeUniqueId">
                <a href="#" class="pure-menu-link dead">Snake 3 <span class="direction">- left</span></a>
              </li>
              <li id="snakeUniqueId">
                <a href="#" class="pure-menu-link won">Snake 4 <span class="direction">- left</span></a>
              </li>
              <li id="snakeUniqueId">
                <a href="#" class="pure-menu-link disconnected">Snake 5</a>
              </li-->
            </ul>
          </div>
      </div>
      <div id="main" class="pure-u-1">
        <div id="signup">
          <input id="name" type="text" placeholder="Name">
          <button id="changeName" class="primary-button pure-button">Change</button>
        </div>
        <canvas id="canvas"></canvas>
      </div>
    </div>
  </body>
<script>

$("#nameBox").leanModal({ top : 200, overlay : 0.4, closeButton: ".modal_close" });

$( document ).ready(function() {
  var canvas = $("#canvas")[0];
  var ctx = canvas.getContext("2d");
  var w = 70;
  var h = 70;
  var cw = 5;

  var me = io();
  var snakes = [];
  var cells = [];
  var started = false;
  var loop;
  var counter = 0;

  function paintWorld(){
    canvas.width = w*cw;
    canvas.height = h*cw;

    ctx.fillStyle = "rgb(37, 42, 58)";
    ctx.fillRect(0, 0, w*cw, h*cw);
    ctx.strokeStyle = "white";
    ctx.strokeRect(0, 0, w*cw, h*cw);
  }

  function run()Â {
    console.log(counter++);
    moveAllLiveSnakes();
    paint();
  }

  function moveAllLiveSnakes() {
    for(var i = 0; i < snakes.length; i++){
      var p = snakes[i];
      if(p.s=="ready"){ // paint only live snakes
        move(p);
        if(p.id==me.id){ // only broadcast my collision
          if(checkCollision(p)){
            me.emit('crashed');
          }
        }
        cells.push({"x": p.c.x, "y": p.c.y});
      }
    }
  }

  function move(snake) {
    if(snake.d == "right"){
      snake.c.x++;
    } else if(snake.d == "left"){
      snake.c.x--;
    } else if(snake.d == "up"){
      snake.c.y--;
    } else if(snake.d == "down") {
      snake.c.y++;
    }
  }

  function checkCollision(snake) {
    var x = snake.c.x;
    var y = snake.c.y;
    if(x == -1 || x == w || y == -1 || y == h){
      return true;
    }

    for(var i = 0; i < cells.length; i++) {
      var c = cells[i];
      if(c.x == x && c.y == y){
        return true;
      }
    }
    return false;
  }

  function paint() {
    for(var i = 0; i < cells.length; i++) {
      var c = cells[i];
      paintCell(c.x, c.y);
    }
  }

  function paintCell(x, y) {
    ctx.fillStyle = "rgb(150, 150, 150)";
    ctx.fillRect(x*cw, y*cw, cw, cw);
    ctx.strokeStyle = "rgb(37, 42, 58)";
    ctx.strokeRect(x*cw, y*cw, cw, cw);
  }

  function exists(snakeID){
    for(var i = 0; i<snakes.length; i++){
      if(snakes[i].id==snakeID) {
        return true;
      }
    }
    return false;
  }

  function dead(snakeID){
    for(var i = 0; i<snakes.length; i++){
      if(snakes[i].id==snakeID && snakes[i].s=="dead") {
        return true;
      }
    }
    return false;
  }

  function findSnake(snakeID){
    for(var i = 0; i<snakes.length; i++){
      if(snakes[i].id==snakeID) {
        return snakes[i];
      }
    }
    return;
  }

  function won(){
    var nrLiveSnakes = 0;
    for(var i = 0; i<snakes.length; i++){
      if(snakes[i].s=="ready"){
        nrLiveSnakes++;
      }
    }
    if(nrLiveSnakes==1){
      return true;
    } else {
      return false;
    }
  }

  function winner(){
    for(var i = 0; i<snakes.length; i++){
      if(snakes[i].s=="ready"){
        return snakes[i];
      }
    }
    return {};
  }

  $(document).keydown(function(e){
    var key = e.which;
    if(key == "83" && exists(me.id) && !started){ // s
      me.emit('ready');
    } else if(key == "76"){ // l
      me.emit('snakes');
    } else if(key == "37" && !dead(me.id) && findSnake(me.id).d != "right" && started){
      me.emit('changeDirection', "left");
    } else if(key == "38" && !dead(me.id) && findSnake(me.id).d != "down" && started){
      me.emit('changeDirection', "up");
    } else if(key == "39" && !dead(me.id) && findSnake(me.id).d != "left" && started){
      me.emit('changeDirection', "right");
    } else if(key == "40" && !dead(me.id) && findSnake(me.id).d != "up" && started){
      me.emit('changeDirection', "down");
    }
  });

  function update(snakes){
    paintWorld();
    $("#snakes").empty();
    for(var i = 0; i < snakes.length; i++){
      if(snakes[i].id==me.id){
        $("#snakes").append($('<li id=\"'+snakes[i].id+'\">').append('<a href=\"#\" class=\"pure-menu-link me '+snakes[i].s+'\">'+snakes[i].n+' <span class=\"direction\">- '+snakes[i].d+'</span></a>'));
        $('#name').val(snakes[i].n);
      } else {
        $("#snakes").append($('<li id=\"'+snakes[i].id+'\">').append('<a href=\"#\" class=\"pure-menu-link '+snakes[i].s+'\">'+snakes[i].n+' <span class=\"direction\">- '+snakes[i].d+'</span></a>'));
      }
    }
  }

  function addSnake(s){
    paintWorld();
    if(s.id==me.id){
      $("#snakes").append($('<li id=\"'+s.id+'\">').append('<a href=\"#\" class=\"pure-menu-link me '+s.n+'\">'+s.id+' <span class=\"direction\">- '+s.d+'</span></a>'));
      $('#name').val(s.n);
    } else {
      $("#snakes").append($('<li id=\"'+s.id+'\">').append('<a href=\"#\" class=\"pure-menu-link '+s.n+'\">'+s.id+' <span class=\"direction\">- '+s.d+'</span></a>'));
    }
  }

  function updateSnake(s){
    //paintWorld();
    if(s.id==me.id){
      $('#'+s.id).html('<a href=\"#\" class=\"pure-menu-link me '+s.s+'\">'+s.n+' <span class=\"direction\">- '+s.d+'</span></a>');
      $('#name').val(s.n);
    } else {
      $('#'+s.id).html('<a href=\"#\" class=\"pure-menu-link '+s.s+'\">'+s.n+' <span class=\"direction\">- '+s.d+'</span></a>');
    }
  }

  $( "#changeName" ).click(function() {
    var s = findSnake(me.id);
    s.n = $('#name').val();
    me.emit('name',s.n);
  });

//-------------------
// communications
//-------------------
  me.on('connect', function() {
    console.log("You'r connected: "+me.id);
  });

  me.on('join', function(msg){
    if(!started){
      snakes = msg;
      update(snakes);
    } else {
      // what to do with with Snakes joining in the middle of game?
    }
  });

  me.on('ready', function(snake){
    if(!started && exists(snake.id)){
      var s = findSnake(snake.id);
      s.s = snake.s;
      updateSnake(s);
    }
  });

  me.on('name', function(snake){
    if(exists(snake.id)){
      var s = findSnake(snake.id);
      s.n = snake.n;
      updateSnake(s);
    }
  });

  me.on('start', function(){
    if(!started){
      console.log("Game started!");
      paintWorld();
      loop = setInterval(run, 100);
      started=true
    }
  });

  me.on('changeDirection', function(snake){
    if(started && exists(snake.id)){
      var s = findSnake(snake.id);
      s.d = snake.d;
      updateSnake(s);
    }
  });

  me.on('crashed', function(snake){
    if(started && exists(snake.id)){
      var s = findSnake(snake.id);
      s.s = snake.s;
      updateSnake(s);
      if(won() && winner().id == me.id){
        me.emit('winner');
      }
    }
  });

  me.on('winner', function(snake){
    if(started && exists(snake.id)){
      var s = findSnake(snake.id);
      s.s = snake.s;
      updateSnake(s);
      console.log("Winner is : "+JSON.stringify(s));
      clearInterval(loop);
      cells = [];
      started = false;
      counter=0;
      me.emit('init');
    }
  });

  me.on('connectionLost', function(snake){
    if(exists(snake.id)){
      var s = findSnake(snake.id);
      s.s = snake.s;
      updateSnake(s);
    }
  });

  me.on('snakes', function(msg){
    update(msg);
  });

  me.on('waiting', function(msg){
    for(var i = 0; i<msg.length; i++){
      addSnake(msg[i]);
    }
  });
});

</script>
</html>
